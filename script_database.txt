CREATE TABLE utente(
nome VARCHAR(100) NOT NULL,
cognome VARCHAR(100) NOT NULL,
email VARCHAR(200) UNIQUE,
username VARCHAR(50) PRIMARY KEY UNIQUE,
password VARCHAR(50) NOT NULL,
logged INTEGER DEFAULT 0);

CREATE TABLE struttura(
nome VARCHAR(200) NOT NULL,
longitudine DOUBLE PRECISION UNIQUE,
latitudine DOUBLE PRECISION UNIQUE,
indirizzo VARCHAR(200) NOT NULL,
informazioni TEXT ,
rating DOUBLE PRECISION DEFAULT 0.0,
categoria enumcategoria NOT NULL,
sottocategoria enumsottocategoria ,
prezzoda DOUBLE PRECISION ,
prezzoa DOUBLE PRECISION,
copertinaurl TEXT NOT NULL,
id SERIAL PRIMARY KEY);

CREATE TABLE foto(
url TEXT PRIMARY KEY UNIQUE,
formato formatofoto NOT NULL,
strutturaid INTEGER REFERENCES struttura(id) ON DELETE CASCADE);

CREATE TABLE recensione(
titolo VARCHAR(100) NOT NULL,
corpo TEXT NOT NULL,
rating INTEGER DEFAULT 1,
usernamecheck INTEGER NOT NULL,
usernameutente VARCHAR(50) REFERENCES utente(username) ON DELETE CASCADE,
strutturaid INTEGER REFERENCES struttura(id) ON DELETE CASCADE,
id SERIAL PRIMARY KEY,
valutazione INTEGER DEFAULT -1);

ALTER TABLE recensione ADD CONSTRAINT usercheckconstraint CHECK(usernamecheck=0 OR usernamecheck=1);
ALTER TABLE utente ADD CONSTRAINT loggedcheck CHECK(logged=0 OR logged=1);
ALTER TABLE recensione ADD CONSTRAINT valutazionecheck CHECK(valutazione=-1 OR valutazione=0 OR valutazione=1);
ALTER TABLE recensione ADD CONSTRAINT ratingcheck CHECK(rating>=1 AND rating<=5);
ALTER TABLE struttura ADD CONSTRAINT categoriacheck CHECK(categoria='alberghi' AND (sottocategoria='hotel' OR sottocategoria='bb' OR sottocategoria='appartamento' OR sottocategoria='altro') OR categoria='ristoranti' AND (sottocategoria='fastfood' OR sottocategoria='pizzeria' OR sottocategoria='ristorante' OR sottocategoria='altro') OR categoria='attrazioni' AND (sottocategoria='zoo' OR sottocategoria='parcogiochi' OR sottocategoria='museo' OR sottocategoria='altro'));
ALTER TABLE utente ADD CONSTRAINT emailcheck CHECK(email ~* '^[A-Za-z0-9._%-]+@[A-Za-z0-9.-]+[.][A-Za-z]+$');
ALTER TABLE utente ADD CONSTRAINT usernamecheck CHECK(username ~* '^[A-Za-z]+[.-_][A-Za-z0-9]+$');

CREATE OR REPLACE FUNCTION eliminarecensione() RETURNS trigger AS $eliminarecensione$ BEGIN DELETE FROM recensione WHERE valutazione=0; RETURN NULL; END; $eliminarecensione$ LANGUAGE plpgsql;
CREATE TRIGGER eliminarecensione AFTER UPDATE ON recensione FOR EACH ROW EXECUTE PROCEDURE eliminarecensione();
CREATE TYPE formatofoto AS ENUM('png','jpeg','jpg');
CREATE TYPE enumcategoria AS ENUM('alberghi','ristoranti','attrazioni');
CREATE TYPE enumsottocategoria AS ENUM('altro','appartamento','bb','hotel','pizzeria','ristorante','fastfood','parcogiochi','zoo','museo');